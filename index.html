<!DOCTYPE html>
<html lang="ja">

<head>
  <title>meta自作差分一覧</title>
  <meta charset="utf-8" />
  <link rel="icon" href="./favicon.png" />
  <meta name="bmstable" content="./header.json" />
  <meta name="viewport" content="width=device-width" />
</head>

<body class="diff">
  <!--　　　　　ここから難易度表本体　　　　　-->
  <div class="tableflame">
    <table cellspacing="1" cellpadding=2 id="bmstable">
      <tr style="color:white;background-color:#666666" height="20">
        <td>Lv</td>
        <td>Title / LR2IR</td>
        <td>Artist / BMS</td>
        <td>Chart</td>
        <td>Comment</td>
      </tr>
    </table>
  </div>
  <script language="javascript" type="text/javascript">
    const addSong = (tableRef, song) => {
      const rowRef = tableRef.insertRow(-1)
      // level
      rowRef.insertCell(-1).appendChild(document.createTextNode(song.level))
      // title & lr2ir
      const title = document.createElement("a")
      title.href = "http://www.dream-pro.info/~lavalse/LR2IR/search.cgi?mode=ranking&bmsmd5=" + song.md5
      title.setAttribute("target", "_blank")
      title.appendChild(document.createTextNode(song.title))
      rowRef.insertCell(-1).appendChild(title)
      // artist & url
      if (song?.url) {
        const artist = document.createElement("a")
        artist.href = song.url
        artist.setAttribute("target", "_blank")
        artist.appendChild(document.createTextNode(song.artist))
        rowRef.insertCell(-1).appendChild(artist)
      } else {
        rowRef.insertCell(-1).appendChild(document.createTextNode(song.artist))
      }
      // chart
      const score = document.createElement("a")
      score.href = song.url_diff
      score.setAttribute("download", "")
      score.appendChild(document.createTextNode("DL"))
      rowRef.insertCell(-1).appendChild(score)
      // comment
      rowRef.insertCell(-1).appendChild(document.createTextNode(song.comment ?? ""))
    }

    const addLevel = (tableRef, symbol, level) => {
      const cell = tableRef.insertRow(-1).insertCell(-1)
      cell.setAttribute("colspan", 6)
      cell.classList.add('level' + level)
      cell.style.textAlign = "center"
      cell.appendChild(document.createTextNode(`${symbol}${level}`))
    }

    const modifyBeforeLevel = (level, count) => {
      const target = document.querySelector('table#bmstable td.level' + level)
      target.innerHTML = target.innerHTML + ` (${count} Songs)`
    }

    const makeTable = (header, data) => {
      let currentLevel = undefined
      let songsCountInLevel = 0
      const tableRef = document.querySelector('table#bmstable')
      const symbol = header.symbol
      data.forEach(song => {
        if (currentLevel !== song.level) {
          if (currentLevel !== undefined) {
            modifyBeforeLevel(currentLevel, songsCountInLevel)
          }
          songsCountInLevel = 0
          currentLevel = song.level
          addLevel(tableRef, symbol, currentLevel)
        }
        addSong(tableRef, song)
        songsCountInLevel++
      });
      modifyBeforeLevel(currentLevel, songsCountInLevel)
    }

    const headerUrl = document.querySelector('meta[name="bmstable"]').content

    fetch(headerUrl)
      .then(response => response.json())
      .then((header) => fetch(header.data_url)
        .then(response => response.json())
        .then((data) => makeTable(header, data))
      );
  </script>
</body>

</html>