<!DOCTYPE html>
<html lang="ja">

<head>
  <title>stella</title>
  <meta charset="utf-8" />
  <link rel="icon" href="/favicon.png" />
  <meta name="bmstable" content="./header.json" />
  <meta name="viewport" content="width=device-width" />
</head>

<body class="diff">
  <!--　　　　　ここから難易度表本体　　　　　-->
  <div class="tableflame">
    <table cellspacing="1" cellpadding=2 id="bmstable">
      <tr style="color:white;background-color:#666666" height="20">
        <td>Lv</td>
        <td>Title / LR2IR</td>
        <td>Artist / BMS</td>
        <td>Chart</td>
        <td>Comment</td>
      </tr>
    </table>
  </div>
  <script language="javascript" type="text/javascript">
    const addSong = (tableRef, song) => {
      const row = tableRef.insertRow(-1)
      // level
      row.insertCell(-1).appendChild(document.createTextNode(song.level))
      // title & lr2ir
      const title = document.createElement("a")
      title.href = "http://www.dream-pro.info/~lavalse/LR2IR/search.cgi?mode=ranking&bmsmd5=" + song.md5
      title.setAttribute("target", "_blank")
      title.appendChild(document.createTextNode(song.title))
      row.insertCell(-1).appendChild(title)
      // artist & url
      if (song?.url) {
        const artist = document.createElement("a")
        artist.href = song.url
        artist.setAttribute("target", "_blank")
        artist.appendChild(document.createTextNode(song.artist))
        row.insertCell(-1).appendChild(artist)
      } else {
        row.insertCell(-1).appendChild(document.createTextNode(song.artist))
      }
      // chart
      const score = document.createElement("a")
      score.href = song.url_diff
      score.setAttribute("download", "")
      score.appendChild(document.createTextNode("DL"))
      row.insertCell(-1).appendChild(score)
      // comment
      row.insertCell(-1).appendChild(document.createTextNode(song.comment ?? ""))
    }

    const addLevel = (tableRef, symbol, level) => {
      const cell = tableRef.insertRow(-1).insertCell(-1)
      cell.setAttribute("colspan", 6)
      cell.classList.add('level' + level)
      cell.style.textAlign = "center"
      cell.appendChild(document.createTextNode(`${symbol}${level}`))
    }

    const modifyBeforeLevel = (level, count) => {
      const target = document.querySelector('table#bmstable td.level' + level)
      target.innerHTML = target.innerHTML + ` (${count} Songs)`
    }

    const makeTable = (header, data) => {
      let currentLevel = undefined
      let songsCountInLevel = 0
      const tableRef = document.querySelector('table#bmstable')
      const symbol = header.symbol
      data.forEach(song => {
        if (currentLevel !== song.level) {
          if (currentLevel !== undefined) {
            modifyBeforeLevel(currentLevel, songsCountInLevel)
          }
          songsCountInLevel = 0
          currentLevel = song.level
          addLevel(tableRef, symbol, currentLevel)
        }
        addSong(tableRef, song)
        songsCountInLevel++
      });
      modifyBeforeLevel(currentLevel, songsCountInLevel)
    }

    // see https://developer.mozilla.org/ja/docs/Web/API/ReadableStreamDefaultReader/read
    async function* makeTextFileLineIterator(fileURL) {
      const utf8Decoder = new TextDecoder('utf-8');
      const response = await fetch(fileURL);
      const reader = response.body.getReader();
      let { value: chunk, done: readerDone } = await reader.read();
      chunk = chunk ? utf8Decoder.decode(chunk) : '';

      const re = /\n|\r|\r\n/gm;
      let startIndex = 0;
      let result;

      while (true) {
        let result = re.exec(chunk);
        if (!result) {
          if (readerDone) break;
          let remainder = chunk.substr(startIndex);
          ({ value: chunk, done: readerDone } = await reader.read());
          chunk = remainder + (chunk ? utf8Decoder.decode(chunk) : '');
          startIndex = re.lastIndex = 0;
          continue;
        }
        yield chunk.substring(startIndex, result.index);
        startIndex = re.lastIndex;
      }

      if (startIndex < chunk.length) {
        // Last line didn't end in a newline char
        yield chunk.substr(startIndex);
      }
    }

    async function run() {
      const header = await fetch(document.querySelector('meta[name="bmstable"]').content)
        .then(response => response.json())

      let currentLevel = undefined
      let songsCountInLevel = 0
      const tableRef = document.querySelector('table#bmstable')
      const symbol = header.symbol
      for await (const line of makeTextFileLineIterator("./data.jsonl")) {
        const song = JSON.parse(line)
        if (currentLevel !== song.level) {
          if (currentLevel !== undefined) {
            modifyBeforeLevel(currentLevel, songsCountInLevel)
          }
          songsCountInLevel = 0
          currentLevel = song.level
          addLevel(tableRef, symbol, currentLevel)
        }
        addSong(tableRef, song)
        songsCountInLevel++
      }
      modifyBeforeLevel(currentLevel, songsCountInLevel)
    }

    run();
  </script>
</body>

</html>